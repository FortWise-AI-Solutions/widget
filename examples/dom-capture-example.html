<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOM Capture Example - Chat Widget</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    h1 {
      color: #667eea;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    
    h2 {
      color: #764ba2;
      margin-top: 30px;
    }
    
    .demo-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      transition: all 0.3s;
    }
    
    button:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    
    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 13px;
    }
    
    .status.info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      color: #1565c0;
    }
    
    .status.success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      color: #2e7d32;
    }
    
    .status.error {
      background: #ffebee;
      border-left: 4px solid #f44336;
      color: #c62828;
    }
    
    .status.warning {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      color: #e65100;
    }
    
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
    }
    
    .card {
      background: white;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .feature-list {
      list-style: none;
      padding: 0;
    }
    
    .feature-list li {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 4px;
      border-left: 3px solid #667eea;
    }
    
    .feature-list li:before {
      content: "‚úì ";
      color: #4caf50;
      font-weight: bold;
      margin-right: 10px;
    }
    
    code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #e91e63;
    }
    
    .hidden-content {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ DOM Capture Example</h1>
    <p>This page demonstrates the DOM capture functionality of the chat widget. The widget can capture the entire page's DOM structure and send it to your server in chunks.</p>

    <div class="demo-section">
      <h2>üìä DOM Statistics</h2>
      <div id="stats" class="status info">
        Click "Get DOM Stats" to see information about the page structure
      </div>
      <div class="controls">
        <button onclick="getStats()">Get DOM Stats</button>
        <button onclick="getStatsWithHidden()">Get Stats (Include Hidden)</button>
      </div>
    </div>

    <div class="demo-section">
      <h2>üì§ Capture and Send</h2>
      <div id="captureStatus" class="status info">
        Ready to capture. Click a button below to start.
      </div>
      <div id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div id="progressBar" class="progress-fill" style="width: 0%">0%</div>
        </div>
      </div>
      <div class="controls">
        <button onclick="captureAndSend()">Capture & Send to Server</button>
        <button onclick="captureAndSendWithProgress()">Capture with Progress</button>
        <button onclick="captureAndSendCustom()">Capture Custom (Include Hidden)</button>
        <button onclick="getChunksOnly()">Get Chunks Only (No Send)</button>
      </div>
    </div>

    <div class="demo-section">
      <h2>üéØ What Gets Captured?</h2>
      <ul class="feature-list">
        <li><strong>Visible Elements:</strong> All visible DOM elements on the page</li>
        <li><strong>Text Content:</strong> All text content from elements</li>
        <li><strong>Attributes:</strong> Relevant attributes (id, class, href, src, etc.)</li>
        <li><strong>Structure:</strong> Complete hierarchical structure of the DOM</li>
        <li><strong>Metadata:</strong> Page URL, title, timestamp, etc.</li>
      </ul>
    </div>

    <div class="demo-section">
      <h2>üö´ What Gets Excluded?</h2>
      <ul class="feature-list">
        <li><strong>Chat Widget:</strong> The chat widget itself is excluded</li>
        <li><strong>Scripts:</strong> &lt;script&gt; tags are not captured</li>
        <li><strong>Styles:</strong> &lt;style&gt; tags are not captured</li>
        <li><strong>Hidden Elements:</strong> By default, display:none elements are excluded</li>
        <li><strong>Meta Tags:</strong> Meta and link tags are excluded</li>
      </ul>
    </div>

    <div class="demo-section">
      <h2>üíª Code Examples</h2>
      
      <h3>Basic Capture and Send</h3>
      <pre><code>// Capture DOM and send to server
await ChatWidget.dom.captureAndSend({
  onProgress: (current, total) => {
    console.log(`Sent ${current}/${total} chunks`);
  }
});</code></pre>

      <h3>Get Statistics Only</h3>
      <pre><code>// Get DOM statistics without capturing
const stats = ChatWidget.dom.getStats();
console.log('Total elements:', stats.totalElements);
console.log('Total size:', stats.totalSize, 'bytes');
console.log('Estimated chunks:', stats.estimatedChunks);</code></pre>

      <h3>Custom Options</h3>
      <pre><code>// Capture with custom options
await ChatWidget.dom.captureAndSend({
  includeHidden: true,        // Include hidden elements
  chunkSize: 100000,          // 100KB per chunk
  maxDepth: 50,               // Maximum depth to traverse
  excludeSelectors: ['.ads'], // Additional selectors to exclude
  metadata: {                 // Custom metadata
    source: 'user-action',
    reason: 'support-request'
  }
});</code></pre>

      <h3>Get Chunks Without Sending</h3>
      <pre><code>// Get chunks as strings without sending to server
const chunks = ChatWidget.dom.getChunks({
  chunkSize: 50000
});
console.log(`Generated ${chunks.length} chunks`);
chunks.forEach((chunk, i) => {
  console.log(`Chunk ${i + 1}:`, chunk.substring(0, 100) + '...');
});</code></pre>
    </div>

    <div class="card">
      <h2>üìù Sample Content</h2>
      <p>This is some sample content that will be captured. The DOM capture will include all text, attributes, and structure.</p>
      <div id="sampleContent">
        <h3>Nested Content</h3>
        <p>This paragraph is nested inside a div.</p>
        <ul>
          <li>List item 1</li>
          <li>List item 2</li>
          <li>List item 3</li>
        </ul>
      </div>
      <div class="hidden-content">
        This content is hidden and won't be captured by default (unless includeHidden is true)
      </div>
    </div>

    <div class="card">
      <h2>üîó Links and Images</h2>
      <p>The capture includes links and image metadata:</p>
      <a href="https://example.com" target="_blank">Example Link</a>
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%23667eea' width='100' height='100'/%3E%3C/svg%3E" alt="Sample SVG" style="width: 100px; height: 100px; margin: 10px 0; border-radius: 8px;">
    </div>

    <div class="demo-section">
      <h2>‚öôÔ∏è Server Integration</h2>
      <p>To receive the captured DOM on your server, implement an endpoint that accepts chunked data:</p>
      <pre><code>// Server endpoint: POST /webhook/dom-capture/:botId
{
  "chunk": "&lt;html&gt;...&lt;/html&gt;",
  "chunkIndex": 0,
  "totalChunks": 5,
  "sessionId": "chat_xxx",
  "visitorId": "visitor_xxx",
  "metadata": {
    "timestamp": "2024-01-01T00:00:00.000Z",
    "url": "https://example.com",
    "title": "Page Title",
    "chatId": "chat_xxx"
  }
}</code></pre>
    </div>
  </div>

  <!-- Load the chat widget -->
  <script type="module">
    import { initChatWidget } from '../dist/chat-widget.js';

    // Initialize the widget
    initChatWidget({
      key: 'demo-key',
      botId: 'demo-bot',
      webhook: {
        url: 'http://localhost:3000',
        route: 'webhook'
      },
      style: {
        theme: 'light',
        position: 'right'
      },
      messages: {
        greeting: 'Hello! I can capture the DOM of this page. Try the buttons above!'
      }
    });

    // Wait for widget to be ready
    window.addEventListener('load', () => {
      console.log('Chat Widget DOM Capture API ready!');
      console.log('Available methods:', window.ChatWidget.dom);
    });
  </script>

  <script>
    // Helper functions for the demo buttons
    
    function updateStats(stats) {
      const statsEl = document.getElementById('stats');
      statsEl.className = 'status success';
      statsEl.innerHTML = `
        <strong>DOM Statistics:</strong><br>
        üì¶ Total Elements: <strong>${stats.totalElements.toLocaleString()}</strong><br>
        üíæ Total Size: <strong>${(stats.totalSize / 1024).toFixed(2)} KB</strong> (${stats.totalSize.toLocaleString()} bytes)<br>
        üìä Estimated Chunks: <strong>${stats.estimatedChunks}</strong><br>
        üìè Average Chunk Size: <strong>${(stats.totalSize / stats.estimatedChunks / 1024).toFixed(2)} KB</strong>
      `;
    }

    function getStats() {
      try {
        const stats = ChatWidget.dom.getStats();
        updateStats(stats);
      } catch (error) {
        showError('stats', error.message);
      }
    }

    function getStatsWithHidden() {
      try {
        const stats = ChatWidget.dom.getStats({
          includeHidden: true
        });
        updateStats(stats);
      } catch (error) {
        showError('stats', error.message);
      }
    }

    function showError(elementId, message) {
      const el = document.getElementById(elementId);
      el.className = 'status error';
      el.innerHTML = `<strong>Error:</strong> ${message}`;
    }

    function showSuccess(elementId, message) {
      const el = document.getElementById(elementId);
      el.className = 'status success';
      el.innerHTML = message;
    }

    function showProgress(percent) {
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressContainer.style.display = 'block';
      progressBar.style.width = percent + '%';
      progressBar.textContent = Math.round(percent) + '%';
    }

    function hideProgress() {
      setTimeout(() => {
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('progressBar').style.width = '0%';
      }, 2000);
    }

    async function captureAndSend() {
      const statusEl = document.getElementById('captureStatus');
      statusEl.className = 'status info';
      statusEl.innerHTML = '‚è≥ Capturing and sending DOM...';

      try {
        const result = await ChatWidget.dom.captureAndSend();
        
        if (result.success) {
          showSuccess('captureStatus', `
            <strong>‚úÖ Success!</strong><br>
            üì§ Sent ${result.chunksSent} chunks to server
          `);
        } else {
          statusEl.className = 'status warning';
          statusEl.innerHTML = `
            <strong>‚ö†Ô∏è Partial Success</strong><br>
            üì§ Sent ${result.chunksSent} chunks<br>
            ‚ùå ${result.errors.length} errors:<br>
            ${result.errors.map(e => `‚Ä¢ ${e}`).join('<br>')}
          `;
        }
      } catch (error) {
        showError('captureStatus', error.message);
      }
    }

    async function captureAndSendWithProgress() {
      const statusEl = document.getElementById('captureStatus');
      statusEl.className = 'status info';
      statusEl.innerHTML = '‚è≥ Capturing and sending DOM with progress tracking...';
      showProgress(0);

      try {
        const result = await ChatWidget.dom.captureAndSend({
          onProgress: (current, total) => {
            const percent = (current / total) * 100;
            showProgress(percent);
            console.log(`Progress: ${current}/${total} chunks (${percent.toFixed(1)}%)`);
          },
          onChunkReady: (chunk, index, total) => {
            console.log(`Chunk ${index + 1}/${total} ready (${chunk.length} chars)`);
          }
        });

        if (result.success) {
          showSuccess('captureStatus', `
            <strong>‚úÖ Success!</strong><br>
            üì§ Sent ${result.chunksSent} chunks to server
          `);
        } else {
          statusEl.className = 'status warning';
          statusEl.innerHTML = `
            <strong>‚ö†Ô∏è Partial Success</strong><br>
            üì§ Sent ${result.chunksSent} chunks<br>
            ‚ùå ${result.errors.length} errors
          `;
        }
        hideProgress();
      } catch (error) {
        showError('captureStatus', error.message);
        hideProgress();
      }
    }

    async function captureAndSendCustom() {
      const statusEl = document.getElementById('captureStatus');
      statusEl.className = 'status info';
      statusEl.innerHTML = '‚è≥ Capturing with custom options (including hidden elements)...';

      try {
        const result = await ChatWidget.dom.captureAndSend({
          includeHidden: true,
          chunkSize: 30000,
          metadata: {
            captureType: 'custom',
            includesHidden: true
          },
          onProgress: (current, total) => {
            console.log(`Sending chunk ${current}/${total}`);
          }
        });

        if (result.success) {
          showSuccess('captureStatus', `
            <strong>‚úÖ Custom Capture Success!</strong><br>
            üì§ Sent ${result.chunksSent} chunks (including hidden elements)
          `);
        } else {
          statusEl.className = 'status warning';
          statusEl.innerHTML = `
            <strong>‚ö†Ô∏è Partial Success</strong><br>
            üì§ Sent ${result.chunksSent} chunks<br>
            ‚ùå ${result.errors.length} errors
          `;
        }
      } catch (error) {
        showError('captureStatus', error.message);
      }
    }

    function getChunksOnly() {
      const statusEl = document.getElementById('captureStatus');
      statusEl.className = 'status info';
      statusEl.innerHTML = '‚è≥ Generating chunks (not sending to server)...';

      try {
        const chunks = ChatWidget.dom.getChunks({ chunkSize: 50000 });
        
        console.log('Generated chunks:', chunks);
        console.log(`Total chunks: ${chunks.length}`);
        chunks.forEach((chunk, i) => {
          console.log(`Chunk ${i + 1} preview:`, chunk.substring(0, 100) + '...');
        });

        showSuccess('captureStatus', `
          <strong>‚úÖ Chunks Generated!</strong><br>
          üì¶ Generated ${chunks.length} chunks<br>
          üíæ Total size: ${(chunks.reduce((sum, c) => sum + c.length, 0) / 1024).toFixed(2)} KB<br>
          üîç Check the browser console to see the chunks
        `);
      } catch (error) {
        showError('captureStatus', error.message);
      }
    }
  </script>
</body>
</html>

